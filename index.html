<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EVM Multi Wallet Checker (Multi-Chain)</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body{margin:0;background:#0b1020;color:#e5e7eb;font:14px/1.45 sans-serif}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center}
    .grid{display:grid;gap:18px;grid-template-columns:420px 1fr;margin-top:16px}
    .card{background:#111827;border-radius:12px;padding:14px;border:1px solid #1f2a44}
    textarea,input,select{width:100%;padding:10px 12px;margin-top:6px;border-radius:10px;border:1px solid #1f2a44;background:#0e152a;color:#e5e7eb}
    textarea{height:160px;resize:vertical}
    button{margin-top:8px;padding:10px 12px;border:0;border-radius:10px;cursor:pointer}
    button.primary{background:#10b981;color:#001b10;font-weight:700}
    button.danger{background:#dc2626;color:#fff}
    button.success{background:#22c55e;color:#fff;font-weight:600}
    table{width:100%;border-collapse:collapse;table-layout:auto}
    th,td{padding:8px;border-bottom:1px solid #1f2a44;text-align:left}
    th{color:#9ca3af;font-weight:600}
    td.address{word-break:break-all;white-space:normal}
    .pill{padding:4px 8px;border:1px solid #1f2a44;border-radius:999px;font-size:12px;margin-right:6px}
    .ok{color:#34d399}.err{color:#fb7185}
    .stats{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    .total{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}
    .totline{font-size:16px;font-weight:700}
    .form{display:flex;flex-direction:column;gap:10px}
    .form-group label{font-size:12px;color:#94a3b8;margin-bottom:4px;display:block}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .filters{margin:8px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .filters button{background:#1f2937;color:#e5e7eb}
    .filters button.active{background:#10b981;color:#001b10;font-weight:700}
    #filterCount{font-size:12px;color:#94a3b8}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;color:#fff}
    .chip .x{background:rgba(0,0,0,0.3);border:0;padding:2px 6px;border-radius:999px;cursor:pointer;color:#fff}
    .divider{height:1px;background:#1f2a44;margin:8px 0}
    .chip.ETH{background:#2563eb}
    .chip.BNB{background:#f59e0b}
    .chip.MATIC{background:#7c3aed}
    .chip.Base{background:#06b6d4}
    .chip.Arbitrum{background:#4b5563}
    .chip.custom{background:#6b7280}
    .summary{margin-top:12px;font-size:14px;line-height:1.5}
    .summary h4{margin:6px 0;color:#94a3b8}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h2>⚡ EVM Multi Wallet Checker (Multi-Chain)</h2>
    <span style="font-size:12px;color:#94a3b8">ethers.js + SheetJS</span>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="form">
        <div class="form-group">
          <label>Wallet addresses (1 per line)</label>
          <textarea id="addrInput" placeholder="0xabc...
0xdef..."></textarea>
        </div>

        <div class="form-group">
          <label>Import from CSV/XLSX</label>
          <div class="row">
            <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" />
            <button class="primary" id="btnImport">Import</button>
            <span class="pill" id="addrCount">0 addr</span>
          </div>
        </div>

        <div class="form-group">
          <label>Pilih RPC Default</label>
          <div class="row" style="width:100%">
            <select id="rpcPreset">
              <option value="">— Pilih Network Preset —</option>
              <option value="Ethereum|https://eth-mainnet.public.blastapi.io|ETH">Ethereum (ETH)</option>
              <option value="BSC|https://bsc-mainnet.public.blastapi.io|BNB">BSC (BNB)</option>
              <option value="Base|https://base-mainnet.public.blastapi.io|ETH">Base (ETH)</option>
              <option value="Arbitrum|https://arbitrum-one.public.blastapi.io|ETH">Arbitrum (ETH)</option>
              <option value="Polygon|https://polygon-mainnet.public.blastapi.io|MATIC">Polygon (MATIC)</option>
            </select>
            <button class="success" id="btnAddPreset">Tambah</button>
            <button class="danger" id="btnClearAll">Hapus Semua</button>
          </div>
          <div id="chosenChains" class="chips"></div>
          <div class="divider"></div>
        </div>

        <div class="form-group">
          <label>Custom RPC URL</label>
          <input id="rpcUrl" placeholder="https://rpc.ankr.com/eth"/>
        </div>
        <div class="form-group">
          <label>Symbol</label>
          <input id="customSymbol" placeholder="ETH"/>
        </div>
        <div class="row">
          <button class="success" id="btnAddCustom">Tambah Custom</button>
        </div>

        <div class="divider"></div>

        <div class="form-group">
          <label>Concurrency</label>
          <input id="concurrency" type="number" value="6"/>
        </div>
        <div class="form-group">
          <label>Timeout (ms)</label>
          <input id="timeout" type="number" value="15000"/>
        </div>

        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="primary" id="btnCheck">Check Wallets</button>
          <button id="btnStop">Stop</button>
          <button id="btnExportCsv">Export CSV</button>
          <button id="btnExportXlsx">Export XLSX</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="stats">
        <span class="pill">Total: <span id="statTotal">0</span></span>
        <span class="pill ok">OK: <span id="statOk">0</span></span>
        <span class="pill err">ERR: <span id="statErr">0</span></span>
        <span class="pill">Duration: <span id="statDur">0s</span></span>
      </div>

      <div class="filters">
        <button id="filterAll" class="active">Semua</button>
        <button id="filterAda">Ada Saldo</button>
        <button id="filterKosong">Kosong</button>
        <span id="filterCount">Menampilkan 0 wallet</span>
      </div>

      <div style="overflow-y:auto;max-height:60vh">
        <table id="resultTable">
          <thead>
            <tr>
              <th>#</th><th>Chain</th><th>Address</th><th>Balance</th><th>Nonce</th><th>Status</th><th>Message</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="summary">
        <h4>Summary Per Chain:</h4>
        <div id="chainSummary">-</div>
      </div>
      <div class="total">
        <span class="totline">Total Balance: <span id="statSum">0</span></span>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const { ethers } = window;
  const el=id=>document.getElementById(id);
  const tbody=document.querySelector('#resultTable tbody');
  const statTotal=el('statTotal'), statOk=el('statOk'), statErr=el('statErr'), statDur=el('statDur'), statSum=el('statSum');
  const filterCount=el('filterCount'); const chainSummaryEl=el('chainSummary');

  let controller={stop:false}, results=[], selectedChains=[];

  // ----- Chips -----
  function renderChosenChains(){
    const wrap=el('chosenChains'); wrap.innerHTML='';
    if(!selectedChains.length){
      wrap.innerHTML='<span style="font-size:12px;color:#94a3b8">Belum ada chain terpilih</span>';
      return;
    }
    selectedChains.forEach((c,idx)=>{
      const chip=document.createElement('div');
      chip.className=`chip ${c.symbol||'custom'}`;
      chip.innerHTML=`<strong>${c.name}</strong> (${c.symbol})`;
      const btn=document.createElement('button');
      btn.className='x'; btn.textContent='×';
      btn.onclick=()=>{ selectedChains.splice(idx,1); renderChosenChains(); };
      chip.appendChild(btn);
      wrap.appendChild(chip);
    });
  }
  el('btnAddPreset').onclick=()=>{
    const v=el('rpcPreset').value; if(!v) return;
    const [name,url,symbol]=v.split('|');
    if(selectedChains.some(c=>c.url===url)) return alert('Sudah ada');
    selectedChains.push({name,url,symbol}); renderChosenChains();
  };
  el('btnClearAll').onclick=()=>{ selectedChains=[]; renderChosenChains(); };
  el('btnAddCustom').onclick=()=>{
    const url=el('rpcUrl').value.trim();
    const symbol=(el('customSymbol').value||'').trim().toUpperCase();
    if(!url||!symbol) return alert('Isi Custom RPC dan Symbol dulu');
    if(selectedChains.some(c=>c.url===url)) return alert('RPC sudah ada di daftar');
    selectedChains.push({name:'Custom',url,symbol}); renderChosenChains();
  };
  renderChosenChains();

  // ----- Table helpers -----
  function addRow(i,chain,addr,sym){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${chain}</td><td class="address">${addr}</td><td data-k="bal">-</td><td data-k="nonce">-</td><td data-k="status">…</td><td data-k="msg"></td>`;
    tbody.appendChild(tr); return tr;
  }
  async function checkOne(provider,addr,i,row,symbol,chain){
    const out={index:i+1,chain,symbol,address:addr,balance:null,nonce:null,status:"OK",message:""};
    try{
      if(!ethers.utils.isAddress(addr)) throw new Error("Invalid address");
      const balWei=await provider.getBalance(addr);
      const nonce=await provider.getTransactionCount(addr);
      const ether=ethers.utils.formatEther(balWei);
      const etherNum=parseFloat(ether);
      row.querySelector('[data-k=bal]').textContent=ether+" "+symbol;
      row.querySelector('[data-k=nonce]').textContent=nonce;
      row.querySelector('[data-k=status]').innerHTML='<span class="ok">OK</span>';
      out.balance=etherNum; out.nonce=nonce; return out;
    }catch(e){
      row.querySelector('[data-k=status]').innerHTML='<span class="err">ERR</span>';
      row.querySelector('[data-k=msg]').textContent=e.message;
      out.status="ERR"; out.message=e.message; return out;
    }
  }

  // ----- Summary -----
  function updateSummary(){
    const summary={}; let total=0;
    results.forEach(r=>{
      if(r && r.status==='OK'){
        summary[r.symbol]=(summary[r.symbol]||0)+(r.balance||0);
        total += (r.balance||0);
      }
    });
    if(!Object.keys(summary).length){ chainSummaryEl.textContent='-'; statSum.textContent='0'; return; }
    chainSummaryEl.innerHTML = Object.entries(summary).map(([sym,t])=>`${sym}: ${t.toFixed(6)}`).join('<br>');
    statSum.textContent = total.toFixed(6);
  }

  // ----- Run (FIXED duplicate custom) -----
  function uniqueChains(list){
    const m=new Map();
    list.forEach(c=>{ if(!m.has(c.url)) m.set(c.url,c); });
    return Array.from(m.values());
  }
  async function run(){
    controller.stop=false; results=[]; tbody.innerHTML='';
    const addrs=(el('addrInput').value||'').split(/\r?\n|,|\s+/).map(s=>s.trim()).filter(Boolean);
    if(!addrs.length) return alert('Isi alamat dulu');

    // start from selected chips
    let chains = uniqueChains([...selectedChains]);

    // add custom only if not already present
    const customUrl = el('rpcUrl').value.trim();
    const customSym = (el('customSymbol').value||'').trim().toUpperCase();
    if(customUrl && customSym && !chains.some(c=>c.url===customUrl)){
      chains.push({name:'Custom', url:customUrl, symbol:customSym});
    }
    chains = uniqueChains(chains);
    if(!chains.length) return alert('Pilih minimal 1 chain');

    statTotal.textContent = addrs.length * chains.length;
    let ok=0,err=0,start=Date.now(); let cursor=0;
    const pool = Number(el('concurrency').value||6);
    const timeout = Number(el('timeout').value||15000);

    const jobs=[];
    chains.forEach(c=> addrs.forEach(addr => jobs.push({url:c.url, sym:c.symbol, addr, chain:c.name})));

    const rows = jobs.map((job,i)=>addRow(i,job.chain,job.addr,job.sym));

    async function worker(){
      while(!controller.stop && cursor<jobs.length){
        const j=cursor++;
        const job=jobs[j], row=rows[j];
        const provider=new ethers.providers.JsonRpcProvider({url:job.url, timeout});
        const res=await checkOne(provider, job.addr, j, row, job.sym, job.chain);
        results[j]=res; (res.status==='OK'?ok++:err++);
        statOk.textContent=ok; statErr.textContent=err; statDur.textContent=((Date.now()-start)/1000).toFixed(1)+'s';
        updateSummary();
      }
    }
    await Promise.all(Array.from({length:Math.min(pool,jobs.length)}, worker));
  }
  el('btnCheck').onclick=run;
  el('btnStop').onclick=()=>controller.stop=true;

  // ----- Import -----
  el('btnImport').onclick=async()=>{
    const f=el('fileInput').files?.[0]; if(!f) return alert('Pilih file dulu');
    const buf=await f.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]]; const rows=XLSX.utils.sheet_to_json(ws,{header:1});
    const addrs=rows.flat().map(x=>String(x||'').trim()).filter(Boolean);
    el('addrInput').value = addrs.join('\n');
    el('addrCount').textContent = addrs.length+' addr';
  };

  // ----- Export -----
  function exportSheet(type){
    if(!results.length) return alert('Belum ada hasil');
    const rows=[["#","Chain","Address","Balance","Nonce","Status","Message"]];
    results.forEach(r=>{
      rows.push([r.index,r.chain,r.address,r.balance!=null?`${r.balance} ${r.symbol}`:"",r.nonce??"",r.status,r.message||""]);
    });
    const ws=XLSX.utils.aoa_to_sheet(rows);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Wallets');
    const fname='wallet-check-'+Date.now()+(type==='csv'?'.csv':'.xlsx');
    XLSX.writeFile(wb,fname,{bookType:type==='csv'?'csv':'xlsx'});
  }
  el('btnExportCsv').onclick=()=>exportSheet('csv');
  el('btnExportXlsx').onclick=()=>exportSheet('xlsx');

  // ----- Filter -----
  function setActive(btn){
    document.querySelectorAll('.filters button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  }
  function applyFilter(type){
    const rows=tbody.querySelectorAll('tr'); let visible=0;
    rows.forEach(row=>{
      const balText=(row.querySelector('[data-k=bal]').textContent.split(' ')[0]||'0');
      const bal=parseFloat(balText)||0;
      let show=true;
      if(type==='ada'&&bal<=0) show=false;
      if(type==='kosong'&&bal!==0) show=false;
      row.style.display=show?'':'none';
      if(show) visible++;
    });
    filterCount.textContent='Menampilkan '+visible+' wallet';
  }
  el('filterAll').onclick=()=>{ setActive(el('filterAll')); applyFilter('all'); };
  el('filterAda').onclick=()=>{ setActive(el('filterAda')); applyFilter('ada'); };
  el('filterKosong').onclick=()=>{ setActive(el('filterKosong')); applyFilter('kosong'); };
})();
</script>
</body>
</html>
