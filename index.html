<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EVM Multi Wallet Checker</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {font-family: sans-serif; background:#0b1020; color:#e5e7eb; margin:0; padding:20px;}
    .container {max-width:1100px; margin:0 auto;}
    .header {display:flex; justify-content:space-between; align-items:center;}
    .grid {display:grid; gap:16px; grid-template-columns:1fr 320px; margin-top:16px;}
    .card {background:#111827; border-radius:10px; padding:14px;}
    textarea,input {width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #1f2a44; background:#0e152a; color:#e5e7eb;}
    textarea{height:140px;}
    button {margin-top:8px; padding:8px 12px; border:0; border-radius:6px; cursor:pointer;}
    button.primary {background:#10b981; color:#001b10; font-weight:700;}
    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th,td{padding:8px; border-bottom:1px solid #1f2a44; text-align:left;}
    .pill{padding:4px 8px; border:1px solid #1f2a44; border-radius:999px; font-size:12px; margin-right:6px;}
    .ok{color:#34d399;} .err{color:#fb7185;}
    .right{margin-left:auto;}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h2>⚡ EVM Multi Wallet Checker</h2>
    <span style="font-size:12px;color:#94a3b8">ethers.js + SheetJS</span>
  </div>

  <div class="grid">
    <div class="card">
      <label>Wallet addresses (1 per line)</label>
      <textarea id="addrInput" placeholder="0xabc...\n0xdef..."></textarea>
      <input type="file" id="fileInput" accept=".csv, .xlsx, .xls"/>
      <button id="btnImport">Import CSV/XLSX</button>
      <label>Custom RPC URL</label>
      <input id="rpcUrl" placeholder="https://rpc.ankr.com/eth"/>
      <label>Concurrency</label>
      <input id="concurrency" type="number" value="6"/>
      <label>Timeout (ms)</label>
      <input id="timeout" type="number" value="15000"/>
      <button class="primary" id="btnCheck">Check Wallets</button>
      <button id="btnStop">Stop</button>
      <button id="btnExportCsv">Export CSV</button>
      <button id="btnExportXlsx">Export XLSX</button>
    </div>

    <div class="card">
      <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;">
        <span class="pill">Total: <span id="statTotal">0</span></span>
        <span class="pill ok">OK: <span id="statOk">0</span></span>
        <span class="pill err">ERR: <span id="statErr">0</span></span>
        <span class="pill right">Duration: <span id="statDur">0s</span></span>
        <span class="pill right">Total Balance: <span id="statSum">0</span></span>
      </div>
      <div style="overflow:auto; max-height:60vh;">
        <table id="resultTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Address</th>
              <th>Balance</th>
              <th>Nonce</th>
              <th>Status</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const { ethers } = window;
  const el = id => document.getElementById(id);
  const tbody = document.querySelector('#resultTable tbody');
  const statTotal = el('statTotal'), statOk = el('statOk'), statErr = el('statErr'), statDur = el('statDur'), statSum = el('statSum');
  let controller = { stop:false }, results = [], sum=0, symbol="NATIVE";

  const chainSymbols = {1:"ETH",56:"BNB",137:"MATIC",43114:"AVAX",42161:"ARB",10:"OP",11155111:"Sepolia"};

  function normalizeAddrs(text){return (text||'').split(/\\r?\\n|,|\\s+/).map(s=>s.trim()).filter(Boolean);}

  async function readFile(file){
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data,{type:'array'});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
    return rows.flat().map(v=>String(v).trim()).filter(Boolean);
  }

  el('btnImport').onclick=async()=>{
    const f=el('fileInput').files[0]; if(!f) return alert("Pilih file");
    const addrs=await readFile(f);
    el('addrInput').value = [...new Set([...normalizeAddrs(el('addrInput').value),...addrs])].join("\\n");
    statTotal.textContent=normalizeAddrs(el('addrInput').value).length;
  }

  function addRow(i,addr){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${addr}</td><td data-k="bal">-</td><td data-k="nonce">-</td><td data-k="status">…</td><td data-k="msg"></td>`;
    tbody.appendChild(tr); return tr;
  }

  async function checkOne(provider,addr,i,row){
    const out={index:i+1,address:addr,balance:null,nonce:null,status:"OK",message:""};
    try{
      if(!ethers.utils.isAddress(addr)) throw new Error("Invalid address");
      const balWei=await provider.getBalance(addr);
      const nonce=await provider.getTransactionCount(addr);
      const ether=ethers.utils.formatEther(balWei);
      row.querySelector('[data-k=bal]').textContent=ether+" "+symbol;
      row.querySelector('[data-k=nonce]').textContent=nonce;
      row.querySelector('[data-k=status]').innerHTML='<span class="ok">OK</span>';
      out.balance=ether; out.nonce=nonce;
      sum+=parseFloat(ether); statSum.textContent=sum.toFixed(6)+" "+symbol;
      return out;
    }catch(e){
      row.querySelector('[data-k=status]').innerHTML='<span class="err">ERR</span>';
      row.querySelector('[data-k=msg]').textContent=e.message;
      out.status="ERR"; out.message=e.message; return out;
    }
  }

  el('btnCheck').onclick=async()=>{
    controller.stop=false; results=[]; tbody.innerHTML=""; sum=0; statSum.textContent="0";
    const addrs=normalizeAddrs(el('addrInput').value); statTotal.textContent=addrs.length;
    if(!addrs.length) return alert("Isi alamat dulu");
    const provider=new ethers.providers.JsonRpcProvider({url:el('rpcUrl').value,timeout:Number(el('timeout').value)});
    const net=await provider.getNetwork(); symbol=chainSymbols[Number(net.chainId)]||"NATIVE";
    let ok=0,err=0,start=Date.now();
    const rows=addrs.map((a,i)=>addRow(i,a));
    let cursor=0,pool=Number(el('concurrency').value||6);

    async function worker(){
      while(!controller.stop && cursor<addrs.length){
        const i=cursor++; const res=await checkOne(provider,addrs[i],i,rows[i]);
        results[i]=res; (res.status==="OK"?ok++:err++);
        statOk.textContent=ok; statErr.textContent=err; statDur.textContent=((Date.now()-start)/1000).toFixed(1)+"s";
      }
    }
    await Promise.all(Array.from({length:Math.min(pool,addrs.length)},worker));
  };

  el('btnStop').onclick=()=>controller.stop=true;

  function exportSheet(type){
    if(!results.length) return alert("Belum ada hasil");
    const rows=[["#","Address","Balance ("+symbol+")","Nonce","Status","Message"]];
    results.forEach(r=>rows.push([r.index,r.address,(r.balance||"")+" "+symbol,r.nonce,r.status,r.message]));
    const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Wallets");
    const fname="wallet-check-"+Date.now()+(type==="csv"?".csv":".xlsx");
    XLSX.writeFile(wb,fname,{bookType:type==="csv"?"csv":"xlsx"});
  }
  el('btnExportCsv').onclick=()=>exportSheet("csv");
  el('btnExportXlsx').onclick=()=>exportSheet("xlsx");
})();
</script>
</body>
</html>
